<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
      <title>2020年武汉新型冠状病毒可视化</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="2020 wuhan Novel coronavirus">

    <meta name="keywords" content="2020 wuhan Novel coronavirus">
    <meta name="author" content="cuihuan">
    <meta name="robots" content="index,follow">


    <link rel="stylesheet" type="text/css" href="./static/css/common.css"/>
    <link rel="stylesheet" type="text/css" href="./static/js/zui/css/zui-theme.css"/>
    <link rel="stylesheet" type="text/css" href="./static/js/zui/css/zui.css"/>
    <link rel="stylesheet" type="text/css" href="./static/js/zui/lib/chosen/chosen.min.css"/>

    <script type="text/javascript" src="./static/js/jquery/jquery2.0.min.js"></script>
    <script type="text/javascript" src="./static/js/common.js"></script>

</head>

<body>
<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">武汉加油</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">
                <span class="muted">武汉加油</span>
            </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li ><a href="./novelCoronavirus.html" target="_self"><i class="icon icon-line-chart"></i> 数据可视化</a></li>
                <li class="active"><a href="./news.html" target="_self"><i class="icon icon-newspaper-o"></i> 最新新闻</a></li>
                <li><a href="./sars.html" target="_self"><i class="icon icon-globe"></i> sars对比</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="./statement.html" target="_blank"><i class="icon icon-chat"></i> 声明</a></li>
            </ul>
        </div>

    </div>
</nav>

<div class="container">
    <div class="alert alert-primary" style="height: 100%">
        各省最新疫情信息：
        <div id="provinceChosen"></div>
    </div>

    <div class="alert alert-success core-data" style="height: 100%">
    </div>

    <div class="chart" id="trend-chart" style="height: 25rem">

    </div>

    <hr/>
    <div class="items" >
    </div>
</div>
<div class="page-footer clear">

    <div class="copyright" style="color:#999999">
        <div >
            请勿用于任务商业用途
        </div>
        <div id="cr_1">
             交流网站：<a href="">cuihuan.net</a>
        </div>
        <div id="cr_2">Copyright © <span class=""> cuihuan </span>
        </div>

    </div>
</div>

</body>
</html>
<script type="text/javascript" src="./static/js/zui/js/zui.js"></script>
<script type="text/javascript" src="./static/js/zui/lib/chosen/chosen.min.js"></script>
<script type="text/javascript" src="./static/js/echart/echarts4.min.js"></script>
<script type="text/javascript">
    var dataUrl  = "http://lab.isaaclin.cn/nCoV/";
    $(document).ready(function () {
        initChosen();
        initNews('');
        initCoreData('');
        initChart('');
    });

    var initNews = function(province) {
        $.ajax({
            url: dataUrl + 'api/news?province=' + province,
            type: 'get',
            success: function (res) {
                if (res.success===true ){
                    var news = res.results;
                    var html = "";
                    for (var i in news) {
                         html +='<div class="item">\n' +
                            '            <div class="item-heading">\n' +
                            '                <div class="pull-right label label-success news-province">'+news[i].provinceName+'</div>\n' +
                            '                <h4><a href="'+news[i].sourceUrl+'" class="news-title" target="_blank">'+news[i].title+'</a></h4>\n' +
                            '            </div>\n' +
                            '            <div class="item-content news-detail" >。\n' + news[i].summary+
                            '            </div>\n' +
                            '            <div class="item-footer">\n' +
                            '                <a href="#" class="text-muted"><i class="icon-comments news-source"></i> '+news[i].infoSource+'</a> &nbsp; <span class="text-muted news-time">'+new Date(news[i].pubDate).toLocaleString()+'</span>\n' +
                            '            </div>\n' +
                            '        </div>';
                    }

                    $(".items").html(html);

                    return ;
                }
                alert("获取数据失败");

            }
        })

    };

    var initChosen = function () {
        $.ajax({
            url: dataUrl + 'api/provinceName',
            type: 'get',
            success: function (res) {
                if (res.success===true ){
                    var provinces = res.results;
                    var html = '<select data-placeholder="选择一个省份，支持缩写" class="chosen-select form-control" tabindex="2">' +
                        '<option value="">全国</option>';
                    for (var i in provinces) {
                        html += '<option value="' + provinces[i] + '">' + provinces[i] + '</option>';
                    }
                    html += '</select>';
                    $("#provinceChosen").html(html);

                    $('select.chosen-select').chosen({
                        no_results_text: '没有找到',    // 当检索时没有找到匹配项时显示的提示文本
                        disable_search_threshold: 4, // 10 个以下的选择项则不显示检索框
                        search_contains: true         // 从任意位置开始检索
                    });

                    $('select.chosen-select').on('change', function () {
                        var province = $('select.chosen-select').val();
                        initNews(province);
                        initCoreData(province);
                        initChart(province);
                    });

                    return;
                }
                alert("获取数据失败");
            }
        });
    };

    var initCoreData = function (province) {

        $.ajax({
            url: dataUrl + 'api/area?latest=1&province=' + province,
            type: 'get',
            success: function (res) {
                if (res.success === true) {
                    var outBreakData = res.results;
                    var confirm  = 0;
                    var suspectedCount  = 0;
                    var curedCount  = 0;
                    var deadCount  = 0;

                    for (var i in outBreakData) {
                        confirm+=outBreakData[i].confirmedCount;
                        suspectedCount+=outBreakData[i].suspectedCount;
                        curedCount+=outBreakData[i].curedCount;
                        deadCount+=outBreakData[i].deadCount;
                    }
                    var html = ' 疫情数据:\n' +
                        '        <div>' +
                        '<span class="label label-warning data-confirmed">确诊</span>：'+confirm+' &nbsp;&nbsp;&nbsp; ' +
                        '<span class="label label-success data-cured">治愈</span>：'+curedCount+'  &nbsp;&nbsp;&nbsp; <span class="label label-danger data-dead">死亡</span>：'+deadCount+'</div>\n' +
                        '    ';


                    $(".core-data").html(html);

                    return;
                }
                alert("获取数据失败");

            }
        })

    };

    var initChart = function (province) {
        if (province==''){
            $.ajax({
                url: dataUrl + 'api/overall?latest=0',
                type: 'get',
                success: function (res) {
                    if (res.success === true) {
                        var chartData = res.results;
                        var date = [];
                        var confirm = [];
                        for (var i in chartData) {
                            var dataTime = new Date(chartData[i].updateTime);
                            var showTime = [dataTime.getFullYear(), dataTime.getMonth() + 1, dataTime.getDate()].join('/');
                            if (date.includes(showTime) || chartData[i].confirmed == 0) {
                                continue;
                            }
                            date.push(showTime);
                            confirm.push(chartData[i].confirmed);
                        }

                        var title = "全国确诊数据";
                        initDetailChart(date, confirm, title);
                        return;
                    }
                    alert("获取数据失败");
                }
            });
        }else{
            $.ajax({
                url: dataUrl + 'api/area?latest=0&province=' + province,
                type: 'get',
                success: function (res) {
                    if (res.success === true) {
                        var chartData = res.results;
                        var date = [];
                        var confirm = [];
                        for (var i in chartData) {
                            var dataTime = new Date(chartData[i].updateTime);
                            var showTime = [dataTime.getFullYear(), dataTime.getMonth() + 1, dataTime.getDate()].join('/');
                            if (date.includes(showTime)) {
                                continue;
                            }
                            date.push(showTime);
                            confirm.push(chartData[i].confirmedCount);
                        }

                        var title = "确诊("+chartData[0].country + " - " + chartData[0].provinceShortName+")";
                        initDetailChart(date, confirm, title);
                        return;
                    }
                    alert("获取数据失败");
                }
            });
        }


        var initDetailChart = function (date,confirm,title) {
            var orderTraceContainer = echarts.init(document.getElementById('trend-chart'));
            orderTraceContainer.showLoading({
                text: '加载中...',
                effect: 'whirling'
            });


            echartsOption  = {
                backgroundColor: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                        offset: 0,
                        color: '#c86589'
                    },
                    {
                        offset: 1,
                        color: '#06a7ff'
                    }
                ], false),
                title: {
                    text: title,
                    left: "center",
                    bottom: "2%",
                    textStyle: {
                        color: "#fff",
                        fontSize: 16
                    }
                },
                grid: {
                    top: '20%',
                    left: '5%',
                    right: '1%',
                    bottom: '15%',
                    containLabel: true,
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    // 时间
                    data: date,
                    axisLabel: {
                        margin: 30,
                        color: '#ffffff63'
                    },
                    axisLine: {
                        show: false
                    },
                    axisTick: {
                        show: true,
                        length: 25,
                        lineStyle: {
                            color: "#ffffff1f"
                        }
                    },
                    splitLine: {
                        show: true,
                        lineStyle: {
                            color: '#ffffff1f'
                        }
                    }
                },
                yAxis: [{
                    type: 'value',
                    position: 'right',
                    axisLabel: {
                        margin: 20,
                        color: '#ffffff63'
                    },

                    axisTick: {
                        show: true,
                        length: 15,
                        lineStyle: {
                            color: "#ffffff1f",
                        }
                    },
                    splitLine: {
                        show: true,
                        lineStyle: {
                            color: '#ffffff1f'
                        }
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#fff',
                            width: 2
                        }
                    }
                }],
                series: [
                    {
                    name: '总数量',
                    type: 'line',
                    smooth: true, //是否平滑曲线显示
                    showAllSymbol: true,
                    symbol: 'circle',
                    symbolSize: 6,
                    lineStyle: {
                        normal: {
                            color: "#fff", // 线条颜色
                        },
                    },
                    label: {
                        show: true,
                        position: 'top',
                        textStyle: {
                            color: '#fff',
                        }
                    },
                    itemStyle: {
                        color: "red",
                        borderColor: "#fff",
                        borderWidth: 3
                    },
                    tooltip: {
                        show: false
                    },
                    areaStyle: {
                        normal: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                                    offset: 0,
                                    color: '#eb64fb'
                                },
                                {
                                    offset: 1,
                                    color: '#3fbbff0d'
                                }
                            ], false),
                        }
                    },
                    data: confirm
                }
                // {
                //     name: '总数量',
                //     type: 'line',
                //     smooth: true, //是否平滑曲线显示
                //     showAllSymbol: true,
                //     symbol: 'circle',
                //     symbolSize: 6,
                //     lineStyle: {
                //         normal: {
                //             color: "#fff", // 线条颜色
                //         },
                //     },
                //     label: {
                //         show: true,
                //         position: 'top',
                //         textStyle: {
                //             color: '#fff',
                //         }
                //     },
                //     itemStyle: {
                //         color: "red",
                //         borderColor: "#fff",
                //         borderWidth: 3
                //     },
                //     tooltip: {
                //         show: false
                //     },
                //     areaStyle: {
                //         normal: {
                //             color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                //                     offset: 0,
                //                     color: '#eb64fb'
                //                 },
                //                 {
                //                     offset: 1,
                //                     color: '#3fbbff0d'
                //                 }
                //             ], false),
                //         }
                //     },
                //     data: [693, 338, 185, 331, 389, 324, 487, 1400, 1100, 1200]
                // }
                ]
            };;
            orderTraceContainer.hideLoading();
            orderTraceContainer.setOption(echartsOption);
        }

    }
</script>
